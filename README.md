# Home Assistant Rsync Backup add-on

This repository hosts a Home Assistant add-on that syncs Home Assistant backups to a remote host using `rsync` over SSH.

It currently defines a single add-on:

- `rsync-backup/` – sync the `/backup` directory from Home Assistant OS to a remote machine using SSH keys.

## Repository layout

- `rsync-backup/`
  - `config.yaml` – Home Assistant add-on manifest
  - `Dockerfile` – container image build for the add-on
  - `run.sh` – container entrypoint that runs rsync in a loop

## How it works

- The add-on mounts the Home Assistant backup directory (`/backup`) read-only.
- It connects to a configured remote host with `rsync` over SSH.
- SSH keys can be either generated by the add-on on first start or provided via configuration.
- The add-on polls on a configurable interval and runs `rsync` to mirror `/backup` to the remote path.

The add-on does not manage creating backups; it only syncs whatever is present in `/backup`.

## Using this add-on with Home Assistant OS

### 1. Add this repository to the Home Assistant add-on store

In Home Assistant OS:

1. Go to **Settings → Add-ons → Add-on Store**.
2. Click the **⋮** menu in the top-right corner and choose **Repositories**.
3. Add this repository URL:

   ```text
   https://github.com/cronus42/homeassistant-rsync-backup
   ```

4. Click **Add**, then **Close**. The store will refresh and list add-ons from this repository.

### 2. Install the Rsync Backup Sync add-on

1. In the **Add-on Store**, search for **"Rsync Backup Sync"**.
2. Open the add-on page and click **Install**.
3. After installation, go to the **Configuration** tab.
4. Configure options (defaults are defined in `rsync-backup/config.yaml`):

   - `remote_host` – hostname or IP of the remote server.
   - `remote_port` – SSH port (default `22`).
   - `remote_user` – SSH user used for rsync (for example `ha-backup`).
   - `remote_path` – target directory on the remote host where backups should be stored.
   - `sync_interval_minutes` – how often to run rsync when the previous run succeeded.
   - `log_level` – one of `DEBUG`, `INFO`, `WARNING`, `ERROR`.
   - `use_generated_key` – if `true`, the add-on generates an SSH keypair and logs the public key.
   - `uploaded_private_key` – optional private key if you prefer to manage keys yourself.
   - `known_hosts` – optional `known_hosts` entries to pin the remote host key.

5. Click **Save**.
6. On the **Info** tab, enable any of the following as needed:

   - **Start on boot**
   - **Watchdog**
   - **Auto update**

7. Click **Start** to run the add-on.

### 3. SSH key setup

You can use either a generated keypair or an uploaded key.

**Option A: Generated keypair (`use_generated_key: true`)**

- On the first start with `use_generated_key: true`, the add-on:
  - Creates an ed25519 keypair under `/data/ssh` inside the add-on.
  - Logs the public key.
- To configure the remote host:
  1. Open the add-on **Log** view.
  2. Copy the logged public key line (it looks like `ssh-ed25519 AAAA...`).
  3. Add it to the remote user's `~/.ssh/authorized_keys` on your backup host.

The generated key is persisted under the add-on's `/data` directory so it survives restarts and upgrades.

**Option B: Uploaded private key (`use_generated_key: false`)**

- Set `use_generated_key` to `false`.
- Paste your private key into `uploaded_private_key` in the add-on configuration.
  - You can paste a multi-line key directly.
  - If you are forced to paste a single line, you can use literal `\n` sequences; the add-on converts them to newlines.
- The add-on writes this key to `/data/ssh/id_ed25519` with `chmod 600` and uses it for SSH.

Home Assistant stores `uploaded_private_key` as a `password`-typed option and handles at-rest encryption. The add-on itself only sees decrypted content via `/data/options.json`.

### 4. Remote host key (known_hosts)

By default, if `known_hosts` is empty, the add-on uses `StrictHostKeyChecking=accept-new` so that the first connection trusts the remote host key and subsequent connections verify it.

For tighter control, you can:

1. Manually capture the remote host key, for example by running `ssh-keyscan` from a trusted machine.
2. Paste the resulting line(s) into the `known_hosts` option.

The add-on will write this to `/data/ssh/known_hosts` and use it via `UserKnownHostsFile`.

### 5. Sync behavior

- Source: `/backup/` inside the Home Assistant OS host (mounted read-only in the add-on).
- Destination: `remote_user@remote_host:remote_path/`.
- Command: effectively:

  ```sh
  rsync -avz --delete -e "ssh ..." /backup/ remote_user@remote_host:remote_path/
  ```

- On each cycle:
  - If rsync **succeeds**, the add-on sleeps for `sync_interval_minutes` and then runs again.
  - If rsync **fails**, it logs the exit code and sleeps 60 seconds before retrying. This avoids hammering a broken remote.

Deletions under `/backup` are mirrored to the remote, because `--delete` is used.

## Development

### Local tooling

- Create a tooling virtualenv and install dev dependencies:

  ```bash
  make venv
  ```

- Install and enable pre-commit hooks:

  ```bash
  make dev-install
  make pre-commit-install
  ```

- Run shellcheck on `run.sh`:

  ```bash
  make shellcheck
  ```

### Local image build

To build the `rsync-backup` add-on image locally for `amd64`:

```bash
make addon-build
```

### Releases and CI

- The add-on version is defined in `rsync-backup/config.yaml`.
- `make release` tags the current commit as `v<version>` and pushes the tag.
- GitHub Actions (`.github/workflows/docker-publish.yml`) builds and pushes multi-arch images to GHCR using image names that match the pattern in `rsync-backup/config.yaml`.
